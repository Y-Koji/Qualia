
http = require 'http'
url = require 'url'
connect = require 'connect'
compression = require 'compression'
bodyParser = require 'body-parser'
rooter = require './rooter.js'
fs = require 'fs'
mkdirp = require 'mkdirp'
exec = require('child_process').exec

app = connect()
	.use compression()
	.use bodyParser.urlencoded({ limit: 1024000000 })
	.use bodyParser.json()
	.use '/', (req, res, next) ->
		obj = url.parse(req.url, true)
		req.query = obj.query
		next()
	.use '/', (req, res, next) ->
		req.url = decodeURIComponent(req.url)
		next()

require('./api.js').set(app).use '/', (req, res, next) ->
	req.url = req.url.replace '/', '/htdocs/'
	rooter res, req.url

module.exports =
	http:
		http.createServer app
	chat:
		require('./chat.js') require('socket.io')(http.createServer())
	syncpad:
		require('./sync-pad.js') require('socket.io')(http.createServer())
		